<!DOCTYPE HTML>
<html>
  <head>
  	<title>Curiosity Hacked</title>
  	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
  	<meta name="description" content="" />
  	<meta name="keywords" content="" />
  	<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,800" rel="stylesheet" type="text/css" />
  	<script src="js/jquery.min.js"></script>
  	<script src="js/jquery.dropotron.min.js"></script>
  	<script src="js/config.js"></script>
  	<script src="js/skel.min.js"></script>
  	<script src="js/skel-panels.min.js"></script>
  	<script src="js/jquery.datetimepicker.js"></script>
  	<noscript>
  		<link rel="stylesheet" href="css/skel-noscript.css" />
  		<link rel="stylesheet" href="css/style.css" />
  		<link rel="stylesheet" href="css/style-desktop.css" />
  	</noscript>
  	<!--[if lte IE 9]><link rel="stylesheet" href="css/ie9.css" /><![endif]-->
  	<!--[if lte IE 8]><script src="js/html5shiv.js"></script><link rel="stylesheet" href="css/ie8.css" /><![endif]-->
  	<!--[if lte IE 7]><link rel="stylesheet" href="css/ie7.css" /><![endif]-->
  	<link rel="stylesheet" href="css/jquery.datetimepicker.css" />

  	<script type="text/javascript" src="js/tinymce/tinymce.min.js"></script>
  	<script type="text/javascript">
  	tinymce.init({
  		selector: "textarea",
  		content_css: "css/style.css",
  		image_advtab: true,
  		plugins: [
         "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
         "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking",
         "save table contextmenu emoticons template paste textcolor responsivefilemanager"
     		],
     		toolbar: " responsivefilemanager save insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons", 
   external_filemanager_path:"/filemanager/",
   filemanager_title:"Responsive Filemanager" ,
   external_plugins: { "filemanager" : "/filemanager/plugin.min.js"}
  	 });
</script>
  </head>
  <body class="no-sidebar">

  	<!-- Header Wrapper -->
  		<div id="header-wrapper">
  			<div class="container">
  				<div class="row">
  					<div class="12u">
  						<!-- Header -->
  					</div>
  				</div>
  			</div>
  		</div>
  	
  	<!-- Main Wrapper -->
  		<div id="main-wrapper">
  			<div class="main-wrapper-style1">
  				<div class="inner">
  					<div class="container">
  						<div class="row">
  							<div class="12u skel-cell-important">
  								<div id="content">

  									<!-- Content -->
  								
  										<article>
<div id='articlenav' class='articlenav'>
<?php
session_start();
if(isset($_SESSION['username']) && isset($_SESSION['adir'])){

$dir_path = $_SERVER["DOCUMENT_ROOT"]."../curiosityhacked-data/".$_SESSION['adir']."/";

if(isset($_GET['file']) && isset($_GET['mode']) && $_GET['mode'] == 'delete'){

$cfile = ereg_replace("[^A-Za-z0-9]", "", $_GET["file"]);

unlink($dir_path.$cfile);
unlink($dir_path."meta.".$cfile);
}

if(isset($_POST['formcontent'])){

$btime = new DateTime($_POST['fdate']);
$bfile = $btime->format('YmdHis');
$bfile = ereg_replace("[^A-Za-z0-9]", "", $bfile);

file_put_contents($dir_path.$bfile, $_POST['formcontent']);

$bmeta['TITLE'] = $_POST['formtitle'];
$bmeta['DATE'] = $_POST['fdate'];
$bmeta['DRAFT'] = $_POST['formdraft'];

$bmetafile = json_encode($bmeta);

file_put_contents($dir_path.'meta.'.$bfile, $bmetafile);
}

$exclude_list = array(".", "..", "dir_passwd");

function filter_meta($file) {
  $needle = "meta.";
  return $needle === "" || strpos($file, $needle) !== 0;
}

function dir_nav() {
  global $exclude_list, $dir_path;
  $directories = array_diff(scandir($dir_path), $exclude_list);
  $directories = array_filter($directories,"filter_meta");
 arsort($directories);
  echo "<table width='100%'><thead><th width='60%'>Title</th><th width='30%'>Date</th><th width='10%'>Draft</th><th>Delete?</th></thead>\n";
  foreach($directories as $entry) {
    if(is_file($dir_path."meta.".$entry)) {
      $fh = file_get_contents($dir_path."meta.".$entry);
      $line = json_decode($fh);
      echo "<tr><td> <a href='?file=".$entry."'>".$line->{'TITLE'}."</a></td><td>".$line->{'DATE'}."</td><td>";
      echo $line->{'DRAFT'}."</td><td><a href='?file=".$entry."&mode=delete' onClick='return confirm(\"Are you sure you want to delete this post?\");'>&#9746;</a></td></tr>";
    }
  }
  echo "</table>";
}
dir_nav();
?>  											
</div>
<!-- Place this in the body of the page content -->
<form method="post" action="edit.php">
    <label>Title: </lable><input name='formtitle' size="40" value="
<?php
 if (isset($_GET["file"])) {
$afile = ereg_replace("[^A-Za-z0-9]", "", $_GET["file"]);
 if(is_file($dir_path."meta.".$afile)) {
      $fh2 = file_get_contents($dir_path."meta.".$afile);
      $line2 = json_decode($fh2);
  echo $line2->{'TITLE'};
  }
}
?>
"> <label>Draft: </label><input type=checkbox name='formdraft' value="DRAFT" 
<?php
if ($line2->{'DRAFT'} == 'DRAFT') { echo "CHECKED"; }
?>
 >
<label>Date: </label>
<input id="datetimepicker" name="fdate" type="text" size="30" placeholder="YYYY-MM-DD HH:MM:SS" value="
<?php
echo $line2->{'DATE'};
?>
">
<script type="text/javascript">
$('#datetimepicker').datetimepicker({ format: 'Y-m-d H:i:s'});
</script>
<a href='edit.php'>Reset</a>
<a href='login.php?logout'>Logout</a>
    <textarea name='formcontent' rows='40'>
<?php
if (isset($_GET["file"])) {
  include $dir_path.$afile;
}
?>
    </textarea>
</form>
<?php } else {

if (isset($_REQUEST['loginfailure'])) { echo "<h3> Login Failure </h3>";}
if (isset($_REQUEST['logoutsucess'])) { echo "<h3> Logout Success </h3>";}
?>
   <a id="login_a" href="#">login</a>
<div id="login_form">
 <div class="err" id="add_err"></div>
 <form method="post" action="login.php">
  <input type='hidden' name='adir' value='
<?php 
if (isset($_REQUEST['a'])) { echo $_REQUEST['a'];}
?>
'>
  <label>User Name:</label>
  <input type="text" id="username" name="username" />
  <label>Password:</label>
  <input type="password" id="password" name="password" />
  <label></label><br/>
  <input type="submit" id="login" value="Login" />
  <input type="button" id="cancel_hide" value="Cancel" />
 </form>
 </div>
 <div id="shadow" class="popup"></div>
  <?php } ?>

  											
  											
  									</article>
  							
  								</div>
  							</div>
  						</div>
  					</div>
  				</div>
  			</div>
  		</div>

  	<!-- Footer Wrapper -->
  </body>
</html>
